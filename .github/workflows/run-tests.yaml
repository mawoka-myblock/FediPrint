name: Cargo Test
on:
  push:
    paths:
      - "src/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "prusaslicer/**"
      - "migrations/**"
      - ".github/workflows/run-tests.yaml"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Compile Custom Postgres
        uses: docker/build-push-action@v5
        with:
          context: pg_uuidv7
          tags: "postgres-uuidv7:latest"
          build-args: |
            PG_MAJOR_VERSION=16
          cache-from: type=gha
          push: false
          cache-to: type=gha,mode=max
      - run: rustup update stable && rustup default stable
      - name: Setup .env
        run: cp .env.example .env
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-tarpaulin
      - name: Deoply docker deps
        run: docker compose -f "docker-compose.yml" up -d --build
#      - run: cargo build --verbose
#      - run: cargo test --verbose
      - uses: Swatinem/rust-cache@v2
      - name: Run tests & Coverage
        run: cargo tarpaulin --all-features --workspace --out Xml --engine=llvm
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4.0.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: mawoka-myblock/FediPrint
      - name: Stop containers
        if: always()
        run: docker-compose -f "docker-compose.yml" down